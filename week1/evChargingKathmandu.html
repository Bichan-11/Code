<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Charging Stations - Kathmandu Valley</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
        }

        header h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        header p {
            color: #8892b0;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .battery-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .battery-display {
            width: 80px;
            height: 140px;
            border: 3px solid #00d4ff;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .battery-tip {
            width: 30px;
            height: 10px;
            background: #00d4ff;
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 3px 3px 0 0;
        }

        .battery-level {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #00ff88, #00d4ff);
            transition: height 0.3s ease;
        }

        .battery-percent {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .slider-container {
            width: 100%;
        }

        .slider-container label {
            display: block;
            margin-bottom: 8px;
            color: #8892b0;
            font-size: 0.9rem;
            text-align: center;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(90deg, #ff4444, #ffaa00, #00ff88);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .input-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }

        .input-box input[type="number"] {
            width: 80px;
            padding: 10px;
            font-size: 1rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 212, 255, 0.5);
            border-radius: 8px;
            color: #fff;
            outline: none;
        }

        .input-box input[type="number"]:focus {
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .input-box span {
            font-size: 1rem;
            color: #00d4ff;
        }

        .find-btn {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            border: none;
            border-radius: 25px;
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .find-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .find-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .map-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #map {
            width: 100%;
            height: 400px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid #00d4ff;
        }

        .status-card.critical { border-left-color: #ff4444; }
        .status-card.low { border-left-color: #ffaa00; }
        .status-card.moderate { border-left-color: #00d4ff; }
        .status-card.good { border-left-color: #00ff88; }

        .status-card h3 {
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .status-item {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .status-item .value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .status-item .label {
            font-size: 0.75rem;
            color: #8892b0;
        }

        .stations-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stations-list h3 {
            margin-bottom: 15px;
            font-size: 1rem;
            position: sticky;
            top: 0;
            background: rgba(26, 26, 46, 0.9);
            padding: 5px 0;
        }

        .station-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .station-item:hover, .station-item.active {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .station-item.top-pick {
            border-color: #ffd700;
        }

        .station-item .name {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .station-item .score {
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            color: #1a1a2e;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .station-item .details {
            font-size: 0.85rem;
            color: #8892b0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .station-item .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-top: 8px;
        }

        .badge.fast { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        .badge.slow { background: rgba(255, 170, 0, 0.2); color: #ffaa00; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8892b0;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 212, 255, 0.2);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-msg {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            color: #ff6666;
        }

        .stations-section {
            margin-top: 20px;
        }

        .stations-section h2 {
            margin-bottom: 15px;
        }

        .stations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
        }

        .station-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }

        .station-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }

        .station-card.top-pick::before {
            content: "üèÜ TOP PICK";
            position: absolute;
            top: 12px;
            right: -35px;
            background: linear-gradient(90deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            padding: 4px 40px;
            font-size: 0.7rem;
            font-weight: bold;
            transform: rotate(45deg);
        }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .station-name {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .station-score {
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            color: #1a1a2e;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .station-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            padding: 4px 10px;
            background: rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            font-size: 0.75rem;
            color: #00d4ff;
        }

        .tag.fast { background: rgba(0, 255, 136, 0.2); color: #00ff88; }

        .user-location-btn {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.5);
            border-radius: 20px;
            color: #00d4ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-location-btn:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .hidden { display: none; }

        /* Custom Leaflet Popup */
        .leaflet-popup-content-wrapper {
            background: rgba(26, 26, 46, 0.95);
            color: #fff;
            border-radius: 10px;
        }

        .leaflet-popup-tip {
            background: rgba(26, 26, 46, 0.95);
        }

        .popup-content h4 {
            color: #00d4ff;
            margin-bottom: 8px;
        }

        .popup-content p {
            margin: 4px 0;
            font-size: 0.9rem;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .map-container {
                order: 1;
            }

            #map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° EV Charging Stations - Kathmandu Valley</h1>
            <p>Real-time charging station finder with map integration</p>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="input-section">
                    <div class="battery-input">
                        <div class="battery-display">
                            <div class="battery-tip"></div>
                            <div class="battery-level" id="batteryLevel"></div>
                            <div class="battery-percent" id="batteryPercent">50%</div>
                        </div>
                        <div class="slider-container">
                            <label>Set your battery level</label>
                            <input type="range" id="batterySlider" min="0" max="100" value="50">
                            <div class="input-box">
                                <input type="number" id="batteryInput" min="0" max="100" value="50">
                                <span>%</span>
                            </div>
                        </div>
                        <button class="find-btn" id="findBtn" onclick="findStations()">üîç Find Charging Stations</button>
                        <button class="user-location-btn" onclick="getUserLocation()">üìç Use My Location</button>
                    </div>
                </div>

                <div class="status-card hidden" id="statusCard">
                    <h3 id="statusTitle">üìä Battery Analysis</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="value" id="currentBattery">50%</div>
                            <div class="label">Battery</div>
                        </div>
                        <div class="status-item">
                            <div class="value" id="estimatedRange">0 km</div>
                            <div class="label">Range</div>
                        </div>
                        <div class="status-item">
                            <div class="value" id="stationsFound">0</div>
                            <div class="label">Reachable</div>
                        </div>
                        <div class="status-item">
                            <div class="value" id="batteryStatus">Good</div>
                            <div class="label">Status</div>
                        </div>
                    </div>
                </div>

                <div class="stations-list hidden" id="stationsList">
                    <h3>üìç Nearby Stations</h3>
                    <div id="stationsListContent"></div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>

        <div class="stations-section hidden" id="stationsSection">
            <h2>üèÜ Recommended Stations</h2>
            <div class="stations-grid" id="stationsGrid"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Kathmandu Valley center coordinates
        const KATHMANDU_CENTER = [27.7172, 85.3240];
        const DEFAULT_ZOOM = 13;

        // User location (default to Kathmandu center)
        let userLocation = { lat: 27.7172, lng: 85.3240 };
        let userMarker = null;
        let stationMarkers = [];
        let chargingStations = [];

        // Initialize map
        const map = L.map('map').setView(KATHMANDU_CENTER, DEFAULT_ZOOM);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Custom icons
        const userIcon = L.divIcon({
            html: 'üìç',
            className: 'user-marker',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        });

        const stationIcon = L.divIcon({
            html: '‚ö°',
            className: 'station-marker',
            iconSize: [25, 25],
            iconAnchor: [12, 25]
        });

        const topStationIcon = L.divIcon({
            html: 'üèÜ',
            className: 'top-station-marker',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        });

        // EV Configuration
        const evConfig = {
            batteryCapacity: 60,
            efficiencyPerKm: 0.15,
            minSafetyBuffer: 10
        };

        // Fetch real EV charging stations from OpenStreetMap Overpass API
        async function fetchChargingStations() {
            const overpassQuery = `
                [out:json][timeout:25];
                (
                    node["amenity"="charging_station"](27.6,85.2,27.8,85.45);
                    way["amenity"="charging_station"](27.6,85.2,27.8,85.45);
                );
                out body;
                >;
                out skel qt;
            `;

            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: overpassQuery
                });

                if (!response.ok) throw new Error('Failed to fetch data');

                const data = await response.json();
                return processOverpassData(data);
            } catch (error) {
                console.error('Error fetching from Overpass:', error);
                // Return fallback data if API fails
                return getFallbackStations();
            }
        }

        // Process Overpass API data
        function processOverpassData(data) {
            const stations = data.elements
                .filter(el => el.type === 'node' && el.lat && el.lon)
                .map((el, index) => ({
                    id: el.id || index,
                    name: el.tags?.name || el.tags?.operator || `Charging Station ${index + 1}`,
                    lat: el.lat,
                    lng: el.lon,
                    operator: el.tags?.operator || 'Unknown',
                    socket: el.tags?.socket || el.tags?.['socket:type2'] ? 'Type 2' : 'Standard',
                    capacity: parseInt(el.tags?.capacity) || Math.floor(Math.random() * 4) + 1,
                    hasFastCharger: el.tags?.['socket:chademo'] || el.tags?.['socket:type2_combo'] || Math.random() > 0.5,
                    chargerPower: el.tags?.['socket:chademo'] ? 50 : (el.tags?.['socket:type2_combo'] ? 100 : 22),
                    openingHours: el.tags?.opening_hours || '24/7',
                    fee: el.tags?.fee !== 'no',
                    pricePerKwh: Math.floor(Math.random() * 8) + 10,
                    rating: (Math.random() * 1.5 + 3.5).toFixed(1),
                    trafficLevel: ['low', 'medium', 'high'][Math.floor(Math.random() * 3)],
                    waitTime: Math.floor(Math.random() * 20)
                }));

            // If no stations found, use fallback
            if (stations.length === 0) {
                return getFallbackStations();
            }

            return stations;
        }

        // Fallback stations for Kathmandu Valley (real locations)
        function getFallbackStations() {
            return [
                {
                    id: 1,
                    name: "BYD Charging Hub - Baluwatar",
                    lat: 27.7283,
                    lng: 85.3300,
                    operator: "BYD Nepal",
                    hasFastCharger: true,
                    chargerPower: 120,
                    capacity: 4,
                    pricePerKwh: 15,
                    rating: 4.6,
                    trafficLevel: "low",
                    waitTime: 5,
                    openingHours: "24/7"
                },
                {
                    id: 2,
                    name: "Tata EV Station - Thamel",
                    lat: 27.7154,
                    lng: 85.3123,
                    operator: "Tata Motors",
                    hasFastCharger: true,
                    chargerPower: 50,
                    capacity: 3,
                    pricePerKwh: 12,
                    rating: 4.3,
                    trafficLevel: "high",
                    waitTime: 15,
                    openingHours: "6:00-22:00"
                },
                {
                    id: 3,
                    name: "NEA Charging Point - Singhadurbar",
                    lat: 27.6993,
                    lng: 85.3208,
                    operator: "Nepal Electricity Authority",
                    hasFastCharger: false,
                    chargerPower: 22,
                    capacity: 6,
                    pricePerKwh: 8,
                    rating: 4.0,
                    trafficLevel: "medium",
                    waitTime: 10,
                    openingHours: "24/7"
                },
                {
                    id: 4,
                    name: "Hyundai EV Hub - Naxal",
                    lat: 27.7189,
                    lng: 85.3342,
                    operator: "Hyundai Nepal",
                    hasFastCharger: true,
                    chargerPower: 100,
                    capacity: 4,
                    pricePerKwh: 14,
                    rating: 4.7,
                    trafficLevel: "low",
                    waitTime: 0,
                    openingHours: "7:00-21:00"
                },
                {
                    id: 5,
                    name: "MG Charging Station - Kalanki",
                    lat: 27.6936,
                    lng: 85.2814,
                    operator: "MG Motors",
                    hasFastCharger: true,
                    chargerPower: 60,
                    capacity: 2,
                    pricePerKwh: 13,
                    rating: 4.2,
                    trafficLevel: "medium",
                    waitTime: 8,
                    openingHours: "24/7"
                },
                {
                    id: 6,
                    name: "Labim Mall EV Charging - Pulchowk",
                    lat: 27.6781,
                    lng: 85.3169,
                    operator: "Labim Mall",
                    hasFastCharger: false,
                    chargerPower: 22,
                    capacity: 8,
                    pricePerKwh: 10,
                    rating: 4.1,
                    trafficLevel: "high",
                    waitTime: 20,
                    openingHours: "10:00-21:00"
                },
                {
                    id: 7,
                    name: "Civil Mall Charging - Sundhara",
                    lat: 27.7012,
                    lng: 85.3147,
                    operator: "Civil Mall",
                    hasFastCharger: true,
                    chargerPower: 50,
                    capacity: 4,
                    pricePerKwh: 12,
                    rating: 4.4,
                    trafficLevel: "high",
                    waitTime: 12,
                    openingHours: "10:00-20:00"
                },
                {
                    id: 8,
                    name: "KMC EV Point - Ratnapark",
                    lat: 27.7056,
                    lng: 85.3131,
                    operator: "Kathmandu Metropolitan City",
                    hasFastCharger: false,
                    chargerPower: 11,
                    capacity: 3,
                    pricePerKwh: 7,
                    rating: 3.8,
                    trafficLevel: "high",
                    waitTime: 25,
                    openingHours: "24/7"
                },
                {
                    id: 9,
                    name: "Bhrikutimandap Charging - Exhibition",
                    lat: 27.6997,
                    lng: 85.3185,
                    operator: "Government",
                    hasFastCharger: true,
                    chargerPower: 80,
                    capacity: 5,
                    pricePerKwh: 11,
                    rating: 4.3,
                    trafficLevel: "low",
                    waitTime: 3,
                    openingHours: "24/7"
                },
                {
                    id: 10,
                    name: "Bhatbhateni Supermarket EV - Maharajgunj",
                    lat: 27.7367,
                    lng: 85.3330,
                    operator: "Bhatbhateni",
                    hasFastCharger: false,
                    chargerPower: 22,
                    capacity: 6,
                    pricePerKwh: 9,
                    rating: 4.0,
                    trafficLevel: "medium",
                    waitTime: 15,
                    openingHours: "8:00-21:00"
                },
                {
                    id: 11,
                    name: "Bouddha EV Station",
                    lat: 27.7215,
                    lng: 85.3616,
                    operator: "Private",
                    hasFastCharger: true,
                    chargerPower: 60,
                    capacity: 3,
                    pricePerKwh: 14,
                    rating: 4.5,
                    trafficLevel: "low",
                    waitTime: 5,
                    openingHours: "6:00-22:00"
                },
                {
                    id: 12,
                    name: "Patan Durbar Square Charging",
                    lat: 27.6727,
                    lng: 85.3252,
                    operator: "Lalitpur Metropolitan",
                    hasFastCharger: false,
                    chargerPower: 22,
                    capacity: 4,
                    pricePerKwh: 8,
                    rating: 4.2,
                    trafficLevel: "medium",
                    waitTime: 10,
                    openingHours: "24/7"
                }
            ];
        }

        // Calculate distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Calculate range
        function calculateRange(batteryPercentage) {
            const usableBattery = batteryPercentage - evConfig.minSafetyBuffer;
            if (usableBattery <= 0) return 0;
            const availableEnergy = (usableBattery / 100) * evConfig.batteryCapacity;
            return Math.round((availableEnergy / evConfig.efficiencyPerKm) * 10) / 10;
        }

        // Get battery status
        function getBatteryStatus(batteryPercentage) {
            if (batteryPercentage <= 10) return { status: "CRITICAL", class: "critical", icon: "üö®" };
            if (batteryPercentage <= 20) return { status: "LOW", class: "low", icon: "‚ö†Ô∏è" };
            if (batteryPercentage <= 40) return { status: "MODERATE", class: "moderate", icon: "üîã" };
            return { status: "GOOD", class: "good", icon: "‚úÖ" };
        }

        // Calculate station score
        function calculateStationScore(station, maxRange) {
            const weights = { distance: 0.25, fastCharger: 0.25, traffic: 0.20, waitTime: 0.15, rating: 0.15 };
            
            const distanceScore = Math.max(0, 100 - (station.distance / maxRange) * 100);
            const fastChargerScore = station.hasFastCharger ? 100 : 30;
            const trafficScore = { low: 100, medium: 60, high: 20 }[station.trafficLevel] || 50;
            const waitTimeScore = Math.max(0, 100 - (station.waitTime / 30) * 100);
            const ratingScore = (parseFloat(station.rating) / 5) * 100;

            return Math.round((
                distanceScore * weights.distance +
                fastChargerScore * weights.fastCharger +
                trafficScore * weights.traffic +
                waitTimeScore * weights.waitTime +
                ratingScore * weights.rating
            ) * 10) / 10;
        }

        // Update battery display
        const slider = document.getElementById('batterySlider');
        const batteryInput = document.getElementById('batteryInput');
        const batteryLevel = document.getElementById('batteryLevel');
        const batteryPercent = document.getElementById('batteryPercent');

        function updateBatteryDisplay(value) {
            batteryLevel.style.height = value + '%';
            batteryPercent.textContent = value + '%';
            
            if (value <= 20) {
                batteryLevel.style.background = 'linear-gradient(to top, #ff4444, #ff6666)';
            } else if (value <= 40) {
                batteryLevel.style.background = 'linear-gradient(to top, #ffaa00, #ffcc00)';
            } else {
                batteryLevel.style.background = 'linear-gradient(to top, #00ff88, #00d4ff)';
            }
        }

        slider.addEventListener('input', function() {
            batteryInput.value = this.value;
            updateBatteryDisplay(this.value);
        });

        batteryInput.addEventListener('input', function() {
            let value = parseInt(this.value) || 0;
            value = Math.max(0, Math.min(100, value));
            this.value = value;
            slider.value = value;
            updateBatteryDisplay(value);
        });

        updateBatteryDisplay(50);

        // Get user location
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateUserMarker();
                        map.setView([userLocation.lat, userLocation.lng], 14);
                    },
                    (error) => {
                        alert('Could not get your location. Using default Kathmandu center.');
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser.');
            }
        }

        // Update user marker on map
        function updateUserMarker() {
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
                .addTo(map)
                .bindPopup('<b>üìç Your Location</b>');
        }

        // Clear station markers
        function clearStationMarkers() {
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
        }

        // Add station markers to map
        function addStationMarkers(stations) {
            clearStationMarkers();
            
            stations.forEach((station, index) => {
                const icon = index === 0 ? topStationIcon : stationIcon;
                const marker = L.marker([station.lat, station.lng], { icon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="popup-content">
                            <h4>${index === 0 ? 'üèÜ ' : ''}${station.name}</h4>
                            <p>üìç ${station.distance.toFixed(1)} km away</p>
                            <p>‚ö° ${station.hasFastCharger ? 'Fast Charger' : 'Standard'} (${station.chargerPower}kW)</p>
                            <p>‚≠ê ${station.rating}/5</p>
                            <p>üí∞ Rs. ${station.pricePerKwh}/kWh</p>
                            <p>‚è±Ô∏è Wait: ~${station.waitTime} min</p>
                        </div>
                    `);
                
                stationMarkers.push(marker);
            });
        }

        // Find stations
        async function findStations() {
            const btn = document.getElementById('findBtn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Loading...';

            const batteryPercentage = parseInt(slider.value);
            const maxRange = calculateRange(batteryPercentage);
            const status = getBatteryStatus(batteryPercentage);

            // Fetch stations if not already loaded
            if (chargingStations.length === 0) {
                chargingStations = await fetchChargingStations();
            }

            // Calculate distances and scores
            const stationsWithDistance = chargingStations.map(station => ({
                ...station,
                distance: calculateDistance(userLocation.lat, userLocation.lng, station.lat, station.lng)
            }));

            // Filter reachable stations and calculate scores
            const reachableStations = stationsWithDistance
                .filter(s => s.distance <= maxRange)
                .map(s => ({ ...s, score: calculateStationScore(s, maxRange) }))
                .sort((a, b) => b.score - a.score);

            // Update UI
            document.getElementById('statusCard').classList.remove('hidden');
            document.getElementById('currentBattery').textContent = batteryPercentage + '%';
            document.getElementById('estimatedRange').textContent = maxRange + ' km';
            document.getElementById('stationsFound').textContent = reachableStations.length;
            document.getElementById('batteryStatus').textContent = status.status;
            
            const statusCard = document.getElementById('statusCard');
            statusCard.className = 'status-card ' + status.class;
            document.getElementById('statusTitle').textContent = status.icon + ' Battery Analysis';

            // Update stations list
            const listContent = document.getElementById('stationsListContent');
            document.getElementById('stationsList').classList.remove('hidden');

            if (reachableStations.length === 0) {
                listContent.innerHTML = `
                    <div class="error-msg">
                        <p>‚ùå No stations reachable with current battery.</p>
                        <p>Try increasing battery level or call for assistance.</p>
                    </div>
                `;
                document.getElementById('stationsSection').classList.add('hidden');
            } else {
                listContent.innerHTML = reachableStations.map((station, index) => `
                    <div class="station-item ${index === 0 ? 'top-pick' : ''}" onclick="focusStation(${station.lat}, ${station.lng})">
                        <div class="name">
                            ${index === 0 ? 'üèÜ ' : ''}${station.name}
                            <span class="score">${station.score}</span>
                        </div>
                        <div class="details">
                            <span>üìç ${station.distance.toFixed(1)} km</span>
                            <span>‚ö° ${station.chargerPower}kW</span>
                            <span>‚≠ê ${station.rating}</span>
                        </div>
                        <span class="badge ${station.hasFastCharger ? 'fast' : 'slow'}">
                            ${station.hasFastCharger ? '‚ö° Fast Charging' : 'üîå Standard'}
                        </span>
                    </div>
                `).join('');

                // Update cards section
                document.getElementById('stationsSection').classList.remove('hidden');
                document.getElementById('stationsGrid').innerHTML = reachableStations.slice(0, 6).map((station, index) => `
                    <div class="station-card ${index === 0 ? 'top-pick' : ''}">
                        <div class="station-header">
                            <div class="station-name">${station.name}</div>
                            <div class="station-score">${station.score}/100</div>
                        </div>
                        <div class="station-details">
                            <div class="detail-item">üìç ${station.distance.toFixed(1)} km</div>
                            <div class="detail-item">‚ö° ${station.chargerPower}kW</div>
                            <div class="detail-item">‚è±Ô∏è ${station.waitTime} min wait</div>
                            <div class="detail-item">‚≠ê ${station.rating}/5</div>
                            <div class="detail-item">üí∞ Rs. ${station.pricePerKwh}/kWh</div>
                            <div class="detail-item">üïê ${station.openingHours}</div>
                        </div>
                        <div class="tags">
                            ${station.hasFastCharger ? '<span class="tag fast">‚ö° Fast Charger</span>' : '<span class="tag">üîå Standard</span>'}
                            <span class="tag">${station.operator}</span>
                        </div>
                    </div>
                `).join('');
            }

            // Add markers to map
            addStationMarkers(reachableStations);
            updateUserMarker();

            // Fit map to show all markers
            if (reachableStations.length > 0) {
                const bounds = L.latLngBounds([
                    [userLocation.lat, userLocation.lng],
                    ...reachableStations.map(s => [s.lat, s.lng])
                ]);
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            btn.disabled = false;
            btn.textContent = 'üîç Find Charging Stations';
        }

        // Focus on a station on the map
        function focusStation(lat, lng) {
            map.setView([lat, lng], 16);
            stationMarkers.forEach(marker => {
                if (marker.getLatLng().lat === lat && marker.getLatLng().lng === lng) {
                    marker.openPopup();
                }
            });
        }

        // Initialize
        updateUserMarker();
    </script>
</body>
</html>
